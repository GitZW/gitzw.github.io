---
layout:     post
title:      IM 消息如何保证时序性
subtitle:   IM 消息如何保证时序性
date:       2020-05-05
author:     ZW
header-img: img/post-bg-os-metro.jpg
catalog: 	 true
tags:
    - IM
---

# 导致消息乱序的原因
* 时间难以保证。在分布式场景中，难以找到一个"全局时钟"去决定消息的时序。
* 网络传输。先发送的消息经过网络传输可能会比后面的消息晚到服务器。
* 多线程。即便是先发送的消息先到达服务器。但是由于多线程，也无法保证先发的消息先处理完成。


# 优化方案一,增加序列号

![img1](/img/20200505_01.jpg)

user1给 user2 依次发送了3条消息（msg1,msg2,msg3），结果经过网络传输或者多线程等原因导致消息是以（msg3,msg2,msg1)的顺序到达user2，这样会导致消息乱序。

![img2](/img/20200505_02.jpg)

给每条消息加上序列号，这样即便是到达user2是乱序的，按指定规则排序后也能正常显示消息顺序



# 优化方案二，设置全局时钟
利用 Redis的原子自增命令incr，DB自带的自增id，或者类似snowflake算法实现一个"取号器"，给每条消息编排顺序。
缺点："取号器"可能出现性能瓶颈
优化：不同的会话不同的"取号器"实例


# 优化方案三，时间同步
通过NTP协议实现集群里的服务器时间同步（误差在毫秒级）。
