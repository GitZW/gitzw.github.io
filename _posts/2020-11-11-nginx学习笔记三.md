---
layout:     post
title:      NGINX 学习笔记（三）
subtitle:   NGINX 学习笔记（三）
date:       2020-11-25
author:     ZW
header-img: img/mysql_img.jpg
catalog: 	 true
tags:
    - NGINX
---

# 指令合并
* 值指令可以合并 root,gzip,access_log 等
* 动作指令不可以合并 proxy_pass,rewrite等
## 合并规则
* 子配置不存在时，直接使用父模块
* 子配置存在时，覆盖父模块配置


# listen 指令 示例
![图一](/img/20201125065054.jpg)

# server_name 指令
* 指令后跟多个域名
* 泛域名
* 正则表达式 （可创建变量）

## 匹配顺序
1. 精准匹配
2. *在前的泛域名
3. *在后的泛域名
4. 按文件中的顺序匹配正则表达式
5. default 值

# http 请求11个阶段


# 如何拿到用户的真实ip
由于网络中存在许多反向代理，所以无法从tcp四元组中获得
http头 X-Forwarded-For 用于传递ip 可以为数组
http头 X-Real-IP 用于传递用户ip 单个值

# rewrite 模块
## return 指令 与 error_page
```
Syntax:	return code [text];
return code URL;
return URL;
Default:	—
Context:	server, location, if
```

```
Syntax:	error_page code ... [=[response]] uri;
Default:	—
Context:	http, server, location, if in location
```

## rewrite 指令
```
Syntax:	rewrite regex replacement [flag];
Default:	—
Context:	server, location, if

An optional flag parameter can be one of:

last
stops processing the current set of ngx_http_rewrite_module directives and starts a search for a new location matching the changed URI;
break
stops processing the current set of ngx_http_rewrite_module directives as with the break directive;
redirect
returns a temporary redirect with the 302 code; used if a replacement string does not start with “http://”, “https://”, or “$scheme”;
permanent
returns a permanent redirect with the 301 code.
```
rewrite_log on | off; 打开重定向日志


## if 指令
```shell script
Syntax:	if (condition) { ... }
Default:	—
Context:	server, location

```

## location 指令
```shell script
Syntax:	location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
Default:	—
Context:	server, location
```
* = : 表示精确匹配后面的url
* ~ : 表示正则匹配，但是区分大小写
* ~* : 正则匹配，不区分大小写
* ^~ : 表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录
* @ : "@" 定义一个命名的 location，使用在内部定向时，例如 error_page

*merge_slashes on | off 合并多个/*

上述匹配规则的优先匹配顺序：

1. = 前缀的指令严格匹配这个查询。如果找到，停止搜索；
2. 所有剩下的常规字符串，最长的匹配。如果这个匹配使用 ^~ 前缀，搜索停止；
3. 正则表达式，在配置文件中定义的顺序；
4. 如果第 3 条规则产生匹配的话，结果被使用。否则，使用第 2 条规则的结果。


## limit_conn 指令
### limit_conn_zone
```shell script
Syntax:	limit_conn_zone key zone=name:size;
Default:	—
Context:	http
```

### limit_conn
```shell script
Syntax:	limit_conn zone number;
Default:	—
Context:	http, server, location
```
* limit_conn_log_level 发生限制时日志级别
* limit_conn_status 发生限制时返回的错误码

## limit_req 指令
### limit_req_zone
```shell script
Syntax:	limit_req_zone key zone=name:size rate=rate [sync];
Default:	—
Context:	http

```
The rate is specified in requests per second (r/s). If a rate of less than one request per second is desired, it is specified in request per minute (r/m). For example, half-request per second is 30r/m.


### limit_req
```shell script
Syntax:	limit_req zone=name [burst=number] [nodelay | delay=number];
Default:	—
Context:	http, server, location
```
